using System;
using System.Collections.Generic;
#if PORTABLE
using System.Net.Http;
using System.Threading.Tasks;
#endif

/*
 * AvaTax Software Development Kit for C#
 *
 * (c) 2004-2019 Avalara, Inc.
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 *
 * @@author     Genevieve Conty <genevieve.conty@avalara.com>
 * @@author     Greg Hester <greg.hester@@avalara.com>
 * @@copyright  2004-2019 Avalara, Inc.
 * @@license    https://www.apache.org/licenses/LICENSE-2.0
 * @@version    @SwaggerModel.ApiVersion
 * @@link       https://github.com/avadev/AvaTax-REST-V2-DotNet-SDK
 */

namespace Avalara.AvaTax.RestClient
{
    public partial class AvaTaxClient
    {
        /// <summary>
        /// Returns the version number of the API used to generate this class
        /// </summary>
        public static string API_VERSION { get { return "@SwaggerModel.ApiVersion"; } }

#region Methods
@foreach(var m in SwaggerModel.Methods) {<text>
        /// <summary>
        /// @CSharpComment(m.Summary, 8)
        /// </summary>
        /// <remarks>
        /// @CSharpComment(m.Description, 8)
        /// </remarks></text>
    foreach (var p in m.Params) {
        if (p.CleanParamName == "X-Avalara-Client") continue;
        WriteLine("        /// <param name=\"" + p.CleanParamName + "\">" + CSharpComment(p.Comment, 8) + "</param>");
    }

    Write("        public " + m.ResponseTypeName + " " + m.Name + "(");

    bool any = false;
    foreach (var p in m.Params) {
        if (p.CleanParamName == "X-Avalara-Client") continue;
        Write(p.TypeName + " " + p.CleanParamName + ", ");
        any = true;
    }
    if (any) {
        Backtrack(2);
    }

    WriteLine(")");
    WriteLine("        {");
	if(m.Name == "AuditAccount") {
		WriteLine("            string startDate = null;");
		WriteLine("            string endDate = null; ");
		WriteLine("            if (start != null)");
		WriteLine("            {");
		WriteLine("			      startDate = string.Format(\"{0}{1}\", start.Value.ToString(\"s\"), \"Z\");");
		WriteLine("            }");
		
		WriteLine("            if (end != null)");
		WriteLine("            {");
		WriteLine("			      endDate = string.Format(\"{0}{1}\", end.Value.ToString(\"s\"), \"Z\");");
		WriteLine("            }");
	}
    WriteLine("            var path = new AvaTaxPath(\"" + m.URI + "\");");
    foreach (var p in m.Params) {
        // Identify clean parameter name - 
        var cleanParamName = p.CleanParamName;
        if (p.TypeName == "DateTime") {
            cleanParamName = p.CleanParamName + ".ToString(\"o\")";
        }

		if (m.Name == "AuditAccount" && cleanParamName == "start") {
			WriteLine("            path.AddQuery(\"start\", startDate);");
		} else if (m.Name == "AuditAccount" && cleanParamName == "end") {
			WriteLine("            path.AddQuery(\"end\", endDate);");
		} else if (p.ParameterLocation == ParameterLocationType.UriPath) {
            WriteLine("            path.ApplyField(\"{0}\", {1});", p.ParamName, cleanParamName);
        } else if (p.ParameterLocation == ParameterLocationType.QueryString) {
            WriteLine("            path.AddQuery(\"{0}\", {1});", p.ParamName, cleanParamName);
        }
    }
    
    var pfrs = m.Params;
	bool hasFileResultParam = false;
	string paramName = "";
	
	for(int i = 0; i < pfrs.Count; i++)
	{
		var pfr = pfrs[i];
		hasFileResultParam = pfr.TypeName == "FileResult";
		
		if(hasFileResultParam) { 
			paramName = pfr.ParamName;
			break;
		}
	}
	
	if (m.ResponseTypeName == "String" && hasFileResultParam) {
		WriteLine("            return RestCallString(\"" + m.HttpVerb.ToUpper() + "\", path, " + (string.IsNullOrEmpty(paramName) ? "null" : paramName) + ");");
    } else if (m.ResponseTypeName == "String") {
        WriteLine("            return RestCallString(\"" + m.HttpVerb.ToUpper() + "\", path, " + (m.BodyParam == null ? "null" : "model") + ");");
	} else if (m.ResponseTypeName == "FileResult") {
        WriteLine("            return RestCallFile(\"" + m.HttpVerb.ToUpper() + "\", path, " + (m.BodyParam == null ? "null" : "model") + ");");
    } else {
        WriteLine("            return RestCall<" + m.ResponseTypeName + ">(\"" + m.HttpVerb.ToUpper() + "\", path, " + (m.BodyParam == null ? "null" : "model") + ");");
    }

    WriteLine("        }");
    WriteLine("");
}
#endregion

#region Asynchronous
#if PORTABLE
@foreach(var m in SwaggerModel.Methods) {<text>
        /// <summary>
        /// @CSharpComment(m.Summary, 8);
        /// </summary>
        /// <remarks>
        /// @CSharpComment(m.Description, 8);
        /// </remarks></text>
    foreach (var p in m.Params) {
        if (p.CleanParamName == "X-Avalara-Client") continue;
        WriteLine("        /// <param name=\"" + p.CleanParamName + "\">" + CSharpComment(p.Comment, 8) + "</param>");
    }
    Write("        public async Task<" + m.ResponseTypeName + "> " + m.Name + "Async(");

    bool any = false;
    foreach (var p in m.Params) {
        if (p.CleanParamName == "X-Avalara-Client") continue;
        Write(p.TypeName + " " + p.CleanParamName + ", ");
        any = true;
    }
    if (any) {
        Backtrack(2);
    }

    WriteLine(")");
    WriteLine("        {");
    WriteLine("            var path = new AvaTaxPath(\"" + m.URI + "\");");
    foreach (var p in m.Params) {
		var cleanParamName = p.CleanParamName;
		
		if (p.TypeName == "DateTime") {
            cleanParamName = p.CleanParamName + ".ToString(\"o\")";
        }
		
        if (p.ParameterLocation == ParameterLocationType.UriPath) {
            WriteLine("            path.ApplyField(\"{0}\", {1});", p.ParamName, cleanParamName);
        } else if (p.ParameterLocation == ParameterLocationType.QueryString) {
            WriteLine("            path.AddQuery(\"{0}\", {1});", p.ParamName, cleanParamName);
        }
    }
	
	var pfr = m.Params;
	bool hasFileResultParam = false;
	string paramName = "";
	
	for(int i = 0; i < pfr.Count; i++)
	{
		var pfrs = pfr[i];
		hasFileResultParam = pfrs.TypeName == "FileResult";
		
		if(hasFileResultParam) { 
			paramName = pfrs.ParamName;
			break;
		}
	}
	
	if (m.ResponseTypeName == "String" && hasFileResultParam) {
		WriteLine("            return await RestCallStringAsync(\"" + m.HttpVerb.ToUpper() + "\", path, " + (string.IsNullOrEmpty(paramName) ? "null" : paramName) + ").ConfigureAwait(false);");
	} else if (m.ResponseTypeName == "String") {
        WriteLine("            return await RestCallStringAsync(\"" + m.HttpVerb.ToUpper() + "\", path, " + (m.BodyParam == null ? "null" : "model") + ").ConfigureAwait(false);");
    } else if (m.ResponseTypeName == "FileResult" && m.Name == "DownloadReport") {
        WriteLine("            return await RestCallFileAsync(\"" + m.HttpVerb.ToUpper() + "\", path, " + (m.BodyParam == null ? "null" : "model") + ").ConfigureAwait(false);");
    } else {
        WriteLine("            return await RestCallAsync<" + m.ResponseTypeName + ">(\"" + m.HttpVerb.ToUpper() + "\", path, " + (m.BodyParam == null ? "null" : "model") + ").ConfigureAwait(false);");
    }
    WriteLine("        }");
    WriteLine("");
}
#endif
#endregion
    }
}
